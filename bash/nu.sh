#!/bin/bash

set -euo pipefail


#======================================================================================================================
# Get nushell version.
#======================================================================================================================

if [ -z "${1-}" ] ; then
    echo "You must pass the NU version to install."
    exit 1
fi
V=${1}


#======================================================================================================================
# Get machine architecture and download URL.
#======================================================================================================================

ARCH=`uname -m`
case "${ARCH}" in
    aarch64|x86_64) FILE="nu-${V}-${ARCH}-unknown-linux-gnu";;
    armv7)          FILE="nu-${V}-${ARCH}-unknown-linux-gnueabihf";;
    *)              echo "Unsupported architecture: ${ARCH}." && exit 1 ;;
esac


#======================================================================================================================
# Download files.
#======================================================================================================================

TMP=`mktemp -d`
cd ${TMP}
URL="https://github.com/nushell/nushell/releases/download/${V}/${FILE}.tar.gz"
wget ${URL}
wget https://gist.githubusercontent.com/bfren/fdc7c7870855a2969068222ed772e5b3/raw/config.nu
wget https://gist.githubusercontent.com/bfren/e7cbb1a04a4e1d1382965fad57e46f26/raw/env.nu


#======================================================================================================================
# Extract files and move into position.
#======================================================================================================================

tar -ozxf ${FILE}.tar.gz
sudo mv ${FILE}/nu* /usr/bin

CONFIG=~/.config/nushell
mkdir -p ${CONFIG} && mv *.nu ${CONFIG}


#======================================================================================================================
# Delete temporary files.
#======================================================================================================================

rm -rf ${TMP}
